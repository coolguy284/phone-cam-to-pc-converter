<!doctype html>
<html lang = 'en'>
  <head>
    <meta charset = 'utf-8'>
    
    <title>Receiver Page</title>
    
    <meta name = 'viewport' content = 'width=device-width, initial-scale=1.0'>
    
    <link rel = 'stylesheet' href = 'style.css'>
    
    <style>
      body {
        align-items: stretch;
        justify-content: stretch;
        
        > div {
          flex-grow: 1;
          justify-content: center;
        }
      }
    </style>
  </head>
  
  <body>
    <div id = 'text_msg_div'>
      <span id = 'text_msg'>-</span>
    </div>
    
    <div id = 'video_div' style = 'display: none;'>
      <video id = 'video'></video>
    </div>
    
    <script>
      // Set text to null to show video, otherwise text will be shown
      function setStatusText(text) {
        if (text == null) {
          text_msg_div.style.display = 'none';
          video_div.style.display = '';
        } else {
          text_msg.textContent = text;
          text_msg_div.style.display = '';
          video_div.style.display = '';
        }
      }
      
      var source, sourceBuffer, queuedBuffers = [], ws = new WebSocket(`ws${location.protocol == 'https:' ? 's' : ''}://${location.host}/video_ws`), removeTimeout;
      
      function StartWatching() {
        source = new MediaSource();
        // it doesnt support srcObject for a mediasource yet
        video.src = URL.createObjectURL(source);
        source.onsourceopen = () => {
          sourceBuffer = source.addSourceBuffer('video/webm; codecs=vp8');
          sourceBuffer.onerror = e => console.error(e);
          sourceBuffer.onupdate = () => {
            if (queuedBuffers.length) sourceBuffer.appendBuffer(queuedBuffers.splice(0, 1)[0]);
          };
          video.play();
        };
        status_span.textContent = 'watching';
      }
      
      ws.onopen = () => {
        ws.onmessage = async msg => {
          let buffer = await msg.data.arrayBuffer();
          //console.log(msg);
          if (sourceBuffer.updating || queuedBuffers.length > 0) {
            queuedBuffers.push(buffer);
          } else {
            sourceBuffer.appendBuffer(buffer);
          }
          if (removeTimeout) clearTimeout(removeTimeout);
          removeTimeout = setTimeout(() => {
            video.src = '';
            video.style.display = 'none';
            status_span.textContent = 'not watching';
          }, 800);
        };
      };
    </script>
  </body>
</html>
